<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="headerfooter.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta charset="UTF-8">
    <title>UserRegist</title>
    <style>
        .userresist-card {
            width: 660px;  /* ã‚«ãƒ¼ãƒ‰ã®æœ€å¤§å¹… */
            margin-top: 50px !important;
            margin: 15px auto; /* ã‚«ãƒ¼ãƒ‰ã®ä¸Šä¸‹å·¦å³ã«ä½™ç™½ã‚’æŒãŸã›ã€ä¸­å¤®æƒãˆ */
            padding: 20px;     /* ã‚«ãƒ¼ãƒ‰å†…ã®ä½™ç™½ */
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1); /* ã‚«ãƒ¼ãƒ‰ã«å½±ã‚’è¿½åŠ ã—ã¦å¼·èª¿ */
            border-radius: 12px; /* ã‚«ãƒ¼ãƒ‰ã®è§’ã‚’ä¸¸ãã™ã‚‹ */
        }

        h3 {
            text-align: center;
            color: #4CAF50;
        }
            
        .userresist-card .v-form {
            display: flex;
            flex-direction: column; /* ç¸¦ã«ä¸¦ã¹ã‚‹ */
            gap: 1px ; /* è¦ç´ é–“ã®é–“éš”ã‚’èª¿æ•´ */
        }
            
        .regist_btn {
            text-align: center;
            background-color: #c6ebc5 !important ;
            color: gray !important ;
            width: 300px;
            margin-bottom: 15px;
        }

        .regist_btn:hover {
                background-color: #b6dab5 !important;
        }
        .dialog-text {
            text-align: center;
            font-size: 18px;
        }
        .login-btn {
                background-color: #c6ebc5 !important;
                color: gray !important;
                width: 200px;
                display: flex !important;
                justify-content: center !important;  /* æ°´å¹³æ–¹å‘ã«ä¸­å¤®æƒãˆ */
                align-items: center !important;      /* å‚ç›´æ–¹å‘ã«ä¸­å¤®æƒãˆ */
        }

        .back-btn {
            width: 100px;
        }
            
        .pass-display {
            margin: 0 !important ;             /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å®Œå…¨ã«ã‚¼ãƒ­ã«ã™ã‚‹ */
            padding: 0 ;           /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã‚¼ãƒ­ã«ã™ã‚‹ */
            padding-bottom: 50px;
            height: 20px !important ;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-app-bar app>
                <h1>ğŸ˜ŠãŠã¡ã‚ƒã‚‰ã‘ğŸ˜Š</h1>
                <v-spacer></v-spacer>
                    <!-- <v-btn onclick="window.location.href = 'home.html';">Home</v-btn> |
                    <v-btn onclick="window.location.href = 'mypage.html';">my page</v-btn> |
                    <v-btn @click="logout()">logout</v-btn> -->
            </v-app-bar>
            <v-main>
                <v-container>
                    <v-card class="userresist-card">
                    <h3>æ–°è¦ä¼šå“¡ç™»éŒ²</h3>
                    <v-form ref="form" v-model="valid">
                        <v-row>
                            <!-- <v-col cols="12">
                                <v-text-field
                                    v-model="nextId"
                                    label="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"
                                    type="number"
                                    required
                                    readonly
                                    class="id-text-field"
                                ></v-text-field>
                            </v-col> -->
                            <v-col cols="12">
                                <v-text-field
                                    v-model="user_name"
                                    label="ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆè‹±æ•°å­—ï¼‰"
                                    color="#1b5e20"
                                    :rules="userNameRules"
                                    required
                                    @input="checkUsername"
                                ></v-text-field>
                                <v-alert v-if="usernameError" type="error">{{ usernameError }}</v-alert>
                            </v-col>
                        </v-row>
                        <v-row>
                            <v-col cols="12">
                                <v-text-field
                                    v-model="password"
                                    :type="showPassword ? 'text' : 'password'"
                                    label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€€8æ–‡å­—ä»¥ä¸Šã§è‹±å¤§å°æ–‡å­—ãƒ»æ•°å­—ã‚’1ã¤ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„"
                                    class="pass-textbox"
                                    color="#1b5e20"
                                    :rules="passwordRules"
                                    required
                                ></v-text-field>
                            </v-col>
                            <v-col cols="12" class="pass-display">
                                <v-checkbox
                                    v-model="showPassword"
                                    label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹"
                                    color="#1b5e20"
                                    dense
                                ></v-checkbox>
                            </v-col>
                        </v-row>
                        <v-row>
                            <v-col cols="12">
                                <v-text-field
                                    v-model="confirmPassword"
                                    :type="showConfirmPassword ? 'text' : 'password'"
                                    class="mb-1"
                                    label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰"
                                    color="#1b5e20"
                                    :rules="confirmPasswordRules"
                                    required
                                ></v-text-field>
                            </v-col>
 
                            <v-col cols="12" class="pass-display">
                                <v-checkbox
                                    v-model="showConfirmPassword"
                                    label="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹"
                                    color="#1b5e20"
                                    dense
                                ></v-checkbox>
                            </v-col>
                        </v-row>
                        <v-row justify="center">
                            <v-btn :disabled="isButtonDisabled" class="regist_btn" @click="addData1">
                                ç™»éŒ²
                            </v-btn>
                        </v-row>
                        <v-row>
                            <v-btn class="back-btn" @click="toIndex">æˆ»ã‚‹</v-btn>
                        </v-row>

                        <div>
                            <v-dialog v-model="dialog" max-width="400px">
                              <v-card>
                                <v-card-title class="headline"></v-card-title>
                                <v-card-text class="dialog-text">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ğŸ˜Š</v-card-text>
                                <v-card-actions>
                                  <v-spacer></v-spacer>
                                  <v-btn class="login-btn" @click="goToLogin">ãƒ­ã‚°ã‚¤ãƒ³</v-btn>
                                  <v-spacer></v-spacer>
                                </v-card-actions>
                              </v-card>
                            </v-dialog>
                          </div>
                        
                        <!-- <v-btn @click="checkFormValidity"  @mouseover="debugButtonState">
                            ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª
                        </v-btn> -->
                    </v-form>
                    </v-card-text>
                    </v-card>
                </v-container>
            </v-main>
        </v-app>
    </div>
 
    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    valid: false,
                    nextId: null,
                    user_name: '',
                    password: '',
                    confirmPassword: '',
                    showPassword: false,
                    showConfirmPassword: false,
                    usernameError: '',
                    userNameRules: [
                        v => !!v || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯å¿…é ˆã§ã™',
                        v => /^[a-zA-Z0-9]+$/.test(v) || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯è‹±æ•°å­—ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„'
                    ],
                    passwordRules: [
                        v => !!v || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™',
                        v => v.length >= 8 || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„',
                        v => /[A-Z]/.test(v) || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯å¤§æ–‡å­—ã‚’1ã¤ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„',
                        v => /[0-9]/.test(v) || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¯æ•°å­—ã‚’1ã¤ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„'
                    ],
                    confirmPasswordRules: [
                        v => !!v || 'ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™',
                        v => v === this.password || 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'
                    ],
                    dialog: false, // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ç®¡ç†
                };
            },
            mounted() {
                this.readNextUserId();
            },
            computed: {
                isButtonDisabled() {
                    return !this.valid || this.usernameError !== '';
                }
            },
            methods: {
                async readNextUserId() {
                    try {
                        const response = await axios.get('https://m3h-kouhei-2010.azurewebsites.net/api/USERSELECT');
                        console.log('Response:', response);
                        console.log('Response data:', response.data);

                        if (response.data && response.data.List) {
                            console.log('List:', response.data.List);
                            const ids = response.data.List.map(userid => Number(userid.user_id));
                            this.nextId = ids.length ? Number(Math.max(...ids) + 1) : 1;
                            console.log('Next ID:', this.nextId);
                        } else {
                            console.error('Unexpected response format:', response.data);
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                    }
                },
                async checkUsername() {
                    console.log('checkUsername é–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ');
                    if (this.user_name.length > 0) {
                        try {
                            const response = await fetch(`https://m3h-kouhei-2010.azurewebsites.net/api/USERCHECK?user_name=${encodeURIComponent(this.user_name)}`);
                            const data = await response.json();
                            if (data.exists) {
                                this.usernameError = 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
                            } else {
                                this.usernameError = '';
                            }
                        } catch (error) {
                            console.error('APIã‚¨ãƒ©ãƒ¼:', error);
                        }
                    } else {
                        this.usernameError = '';
                    }
                },
                async addData1() {
                    console.log("addData1ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");

                    // æ‰‹å‹•ã§ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
                    const isValid = this.$refs.form.validate();
                    console.log("ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:", isValid);

                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€šã£ã¦ã„ã‚‹ã‹ç¢ºèª
                    if (!isValid || this.usernameError) {
                        console.log('ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }

                    // nextIdãŒæ•°å€¤ã‹ã©ã†ã‹ã‚’ç¢ºèª
                    if (!this.nextId || isNaN(Number(this.nextId))) {
                        console.log("IDã«æ•°å€¤ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
                        return;
                    }

                    const param = {
                        user_id: Number(this.nextId),
                        user_name: this.user_name,
                        user_password: this.password,
                    };

                    try {
                        const response = await axios.post('https://m3h-kouhei-2010.azurewebsites.net/api/USERINSERT', param);
                        console.log("ãƒ‡ãƒ¼ã‚¿è¿½åŠ æˆåŠŸ:", response.data);
                        // window.location.href = 'userlogin.html';
                        // ãƒ‡ãƒ¼ã‚¿è¿½åŠ æˆåŠŸæ™‚ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                        this.dialog = true;
                    } catch (error) {
                        if (error.response) {
                            console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', error.response.status);
                            console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.response.data);
                        } else if (error.request) {
                            console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error.request);
                        } else {
                            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                            console.error('ã‚¨ãƒ©ãƒ¼:', error.message);
                        }
                        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.config);
                    }
                },
                goToLogin() {
                    window.location.href = 'userlogin.html';
                },
                toIndex(){
                        window.location.href = 'index.html';
                }

                // async checkFormValidity() {
                //     // æ‰‹å‹•ã§ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
                //     const isValid = this.$refs.form.validate();
                //     console.log("ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:", isValid);
                //     console.log("ç¾åœ¨ã®validã®çŠ¶æ…‹:", this.valid);
                //     console.log("ç¾åœ¨ã®usernameError:", this.usernameError);
                // },

                // debugButtonState() {
                //     console.log("ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹:", !this.valid || this.usernameError);
                // }
            }
        });
    </script>    
</body>
</html>
